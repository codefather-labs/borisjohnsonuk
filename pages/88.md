messages, and the simplest protocol is to prefix each message with a size header, followed by a message payload of that size. The utility library in  Example 4-1  provides *read*  and  *write*  capabilities for such messages. *Example 4-1. Message protocol: read and write* `# msgproto.py` `from` ` ` `asyncio` ` ` `import` ` ` `StreamReader` `,` ` ` `StreamWriter` `async` ` ` `def` ` ` `read_msg` `(` `stream` `:` ` ` `StreamReader` `)` ` ` `->` ` ` `bytes` `:` `    ` `size_bytes` ` ` `=` ` ` `await` ` ` `stream` `.` `readexactly` `(` `4` `)` `  ` `    ` `size` ` ` `=` ` ` `int` `.` `from_bytes` `(` `size_bytes` `,` ` ` `byteorder` `=` `'big'` `)` `  ` `    ` `data` ` ` `=` ` ` `await` ` ` `stream` `.` `readexactly` `(` `size` `)` `  ` `    ` `return` ` ` `data` `async` ` ` `def` ` ` `send_msg` `(` `stream` `:` ` ` `StreamWriter` `,` ` ` `data` `:` ` ` `bytes` `):` `    ` `size_bytes` ` ` `=` ` ` `len` `(` `data` `)` `.` `to_bytes` `(` `4` `,` ` ` `byteorder` `=` `'big'` `)` `    ` `stream` `.` `writelines` `([` `size_bytes` `,` ` ` `data` `])` `  ` `    ` `await` ` ` `stream` `.` `drain` `()` Get the first 4 bytes. This is the size prefix. Those 4 bytes must be converted into an integer. Now we know the payload size, so we read that off the stream. *Write*  is the inverse of  *read* : first we send the length of the data, encoded as 4 bytes, and thereafter the data. Now that we have a rudimentary message protocol, we can focus on the message broker application in  Example 4-2 . *Example 4-2. A 40-line prototype server* `# mq_server.py` `import` ` ` `asyncio` `from` ` ` `asyncio` ` ` `import` ` ` `StreamReader` `,` ` ` `StreamWriter` `,` ` ` `gather` `from` ` ` `collections` ` ` `import` ` ` `deque` `,` ` ` `defaultdict` `from` ` ` `typing` ` ` `import` ` ` `Deque` `,` ` ` `DefaultDict` `from` ` ` `msgproto` ` ` `import` ` ` `read_msg` `,` ` ` `send_msg` `  ` `SUBSCRIBERS` `:` ` ` `DefaultDict` `[` `bytes` `,` ` ` `Deque` `]` ` ` `=` ` ` `defaultdict` `(` `deque` `)` ` ` `async` ` ` `def` ` ` `client` `(` `reader` `:` ` ` `StreamReader` `,` ` ` `writer` `:` ` ` `StreamWriter` `):` `  ` `peername` ` ` `=` ` ` `writer` `.` `get_extra_info` `(` `'peername'` `)` `  ` `  ` `subscribe_chan` ` ` `=` ` ` `await` ` ` `read_msg` `(` `reader` `)` `  ` `  ` `SUBSCRIBERS` `[` `subscribe_chan` `]` `.` `append` `(` `writer` `)` `  ` `  ` `print` `(` `f` `'Remote ` `{peername}` ` subscribed to ` `{subscribe_chan}` `'` `)` **Streams (Standard Library) ** **| ** **77**