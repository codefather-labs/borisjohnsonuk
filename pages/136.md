4  You  *also*  need the  `RETURNING id`  part of the SQL, though! I called this function from the Sanic module inside the  `new_patron()`  endpoint for adding new patrons. Inside the function, I use the  `fetchval()`  method to insert new data. Why  `fetchval()`  and not  `execute()` ? Because  `fetchval()` returns the primary key of the new inserted record! 4 Update an existing record. When this succeeds, PostgreSQL will return  `UPDATE 1` , so I use that as a check to verify that the update succeeded. Deletion is very similar to updating. This is the read operation. This is the only part of our CRUD interface that cares about the cache. Think about that for a second: we don’t update the cache when doing an insert, update, or delete. This is because we rely on the async notification from the database (via the installed triggers) to update the cache if any data is changed. Of course, we do still want to use the cache after the first  `GET` . The  `db_event()`  function is the callback that  `asyncpg`  will make when there are events on our DB notification channel,  `chan_patron` . This specific parameter list is required by  `asyncpg` .  `conn`  is the connection on which the event was sent,  `pid` is the process ID of the PostgreSQL instance that sent the event,  `channel`  is the name of the channel (which in this case will be  `chan_patron` ), and the payload is the data being sent on the channel. Deserialize the JSON data to a dict. The cache population is generally quite straightforward, but note that update events contain both new and old data, so we need to make sure to cache the new data only. This is a small utility function I’ve made to easily re-create a table if it’s missing. This is really useful if you need to do this frequently—such as when writing the code samples for this book! This is also where the database notification triggers are created and added to our `patron`  table. See  Example B-1  for annotated listing of these functions. That brings us to the end of this case study. We’ve seen how Sanic makes it very simple to create an API server, and we’ve seen how to use  `asyncpg`  for performing queries **asyncpg and Sanic ** **| ** **125**