The upshot is that when the database changes,  *all connected app instances*  get notified, allowing them to update their caches. With this explanation out of the way, we can now look at the  `asyncpg`  code implementation required to make our cache invalidation actually work. The basic design for the server code shown in  Example 4-23  is the following: 1.  We have a simple web API using the new,  `asyncio` -compatible  Sanic web framework . 2.  The data will be stored in a backend PostgreSQL instance, but the API will be served via multiple instances of the web API app servers. 3.  The app servers will cache data from the database. 4.  The app servers will subscribe to events via  `asyncpg`  in specific tables on the DB, and will receive update notifications when the data in the DB table has been changed. This allows the app servers to update their individual in-memory caches. *Example 4-23. API server with Sanic* `# sanic_demo.py` `import` ` ` `argparse` `from` ` ` `sanic` ` ` `import` ` ` `Sanic` `from` ` ` `sanic.views` ` ` `import` ` ` `HTTPMethodView` `from` ` ` `sanic.response` ` ` `import` ` ` `json` `from` ` ` `util` ` ` `import` ` ` `Database` `  ` `from` ` ` `perf` ` ` `import` ` ` `aelapsed` `,` ` ` `aprofiler` `  ` `import` ` ` `model` `app` ` ` `=` ` ` `Sanic` `()` `  ` `@aelapsed` `async` ` ` `def` ` ` `new_patron` `(` `request` `):` `  ` `    ` `data` ` ` `=` ` ` `request` `.` `json` `  ` `    ` `id` ` ` `=` ` ` `await` ` ` `model` `.` `add_patron` `(` `app` `.` `pool` `,` ` ` `data` `)` `  ` `    ` `return` ` ` `json` `(` `dict` `(` `msg` `=` `'ok'` `,` ` ` `id` `=` `id` `))` `  ` `class` ` ` `PatronAPI` `(` `HTTPMethodView` `,` ` ` `metaclass` `=` `aprofiler` `):` `  ` `    ` `async` ` ` `def` ` ` `get` `(` `self` `,` ` ` `request` `,` ` ` `id` `):` `        ` `data` ` ` `=` ` ` `await` ` ` `model` `.` `get_patron` `(` `app` `.` `pool` `,` ` ` `id` `)` `  ` `        ` `return` ` ` `json` `(` `data` `)` `    ` `async` ` ` `def` ` ` `put` `(` `self` `,` ` ` `request` `,` ` ` `id` `):` `        ` `data` ` ` `=` ` ` `request` `.` `json` `        ` `ok` ` ` `=` ` ` `await` ` ` `model` `.` `update_patron` `(` `app` `.` `pool` `,` ` ` `id` `,` ` ` `data` `)` `        ` `return` ` ` `json` `(` `dict` `(` `msg` `=` `'ok'` ` ` `if` ` ` `ok` ` ` `else` ` ` `'bad'` `))` `  ` **120 ** **| ** **Chapter 4: 20 Asyncio Libraries You Aren’t Using (But…Oh, Never Mind)**